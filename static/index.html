<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="TR-AIS">
  <title>TR-AIS</title>
  <style>
    :root {
      --bg: #121212;
      --surface: #1e1e1e;
      --surface2: #2a2a2a;
      --border: #333;
      --text: #e0e0e0;
      --text-dim: #888;
      --accent: #ff5722;
      --accent-dim: rgba(255, 87, 34, 0.3);
      --accent-glow: rgba(255, 87, 34, 0.15);
      --green: #4caf50;
      --green-dim: rgba(76, 175, 80, 0.3);
      --step-on: #ff5722;
      --step-ghost: #ff8a65;
      --step-off: #2a2a2a;
      --step-cursor: #4caf50;
      --user-msg: #1a3a5c;
      --ai-msg: #2a2a2a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- Header --- */
    .header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      gap: 8px;
      flex-shrink: 0;
    }

    .logo {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
    }

    .logo span {
      color: var(--text-dim);
      font-weight: 400;
      font-size: 12px;
      margin-left: 6px;
    }

    .session-select {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 13px;
      min-width: 0;
    }

    .btn-icon {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* --- Main Content --- */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- Chat --- */
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scroll-behavior: smooth;
    }

    .msg {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .msg.user {
      align-self: flex-end;
      background: var(--user-msg);
      border-bottom-right-radius: 4px;
    }

    .msg.assistant {
      align-self: flex-start;
      background: var(--ai-msg);
      border-bottom-left-radius: 4px;
    }

    .msg.system {
      align-self: center;
      color: var(--text-dim);
      font-size: 12px;
      padding: 4px 12px;
    }

    .msg .kit-tag {
      display: inline-block;
      background: var(--accent-dim);
      color: var(--accent);
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 6px;
    }

    .typing-indicator {
      align-self: flex-start;
      color: var(--text-dim);
      font-size: 13px;
      padding: 8px 14px;
      display: none;
    }

    .typing-indicator.show {
      display: block;
    }

    .typing-indicator span {
      animation: blink 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {

      0%,
      60%,
      100% {
        opacity: 0.2;
      }

      30% {
        opacity: 1;
      }
    }

    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      text-align: center;
      padding: 20px;
      gap: 8px;
    }

    .welcome h2 {
      color: var(--text);
      font-size: 20px;
    }

    .welcome p {
      font-size: 14px;
      max-width: 400px;
    }

    .welcome .examples {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .welcome .example-chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .welcome .example-chip:hover {
      border-color: var(--accent);
    }

    /* --- Pattern Grid --- */
    .grid-panel {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      flex-shrink: 0;
      overflow-x: auto;
      display: none;
    }

    .grid-panel.show {
      display: block;
    }

    .grid-table {
      width: 100%;
      min-width: 360px;
    }

    .grid-row {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-bottom: 2px;
    }

    .grid-label {
      width: 28px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-dim);
      text-align: right;
      padding-right: 4px;
      flex-shrink: 0;
    }

    .grid-steps {
      display: flex;
      gap: 2px;
      flex: 1;
    }

    .grid-step {
      flex: 1;
      aspect-ratio: 1;
      max-height: 20px;
      border-radius: 3px;
      background: var(--step-off);
      transition: background 0.05s;
      min-width: 12px;
    }

    .grid-step.on {
      background: var(--step-on);
    }

    .grid-step.ghost {
      background: var(--step-ghost);
      opacity: 0.5;
    }

    .grid-step.cursor {
      box-shadow: inset 0 0 0 2px var(--step-cursor);
    }

    .grid-step.beat-marker {
      border-top: 2px solid #444;
    }

    /* --- Controls --- */
    .controls {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      flex-shrink: 0;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls-row+.controls-row {
      margin-top: 6px;
    }

    .btn-play {
      width: 44px;
      height: 36px;
      border-radius: 8px;
      border: 2px solid var(--accent);
      background: transparent;
      color: var(--accent);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .btn-play:hover {
      background: var(--accent-dim);
    }

    .btn-play.playing {
      background: var(--accent);
      color: white;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }

    .slider-group label {
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      min-width: 28px;
    }

    .slider-group input[type="range"] {
      flex: 1;
      min-width: 60px;
      accent-color: var(--accent);
      height: 4px;
    }

    .slider-group .slider-val {
      font-size: 12px;
      color: var(--text);
      min-width: 30px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .version-nav {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-dim);
      white-space: nowrap;
    }

    .version-nav button {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .version-nav button:hover {
      border-color: var(--accent);
    }

    .version-nav button:disabled {
      opacity: 0.3;
      cursor: default;
    }

    /* --- Input Bar --- */
    .input-bar {
      display: flex;
      padding: 8px 12px;
      gap: 8px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .input-bar input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }

    .input-bar input:focus {
      border-color: var(--accent);
    }

    .input-bar input::placeholder {
      color: var(--text-dim);
    }

    .btn-send {
      background: var(--accent);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .btn-send:disabled {
      opacity: 0.4;
      cursor: default;
    }

    /* Status indicator */
    .status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-dim);
      margin-left: auto;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
    }

    .status-dot.disconnected {
      background: #f44336;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header">
    <div class="logo">ü•Å TR-AIS <span>Roland TR-8S</span></div>
    <select class="session-select" id="sessionSelect" onchange="switchSession(this.value)">
      <option value="">Select session...</option>
    </select>
    <button class="btn-icon" onclick="createSession()" title="New Session">+</button>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting</span>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="main">
    <div class="chat" id="chat">
      <div class="welcome" id="welcome">
        <h2>ü•Å Ready to jam</h2>
        <p>Create a session and describe the beat you want. I'll program your TR-8S in real time.</p>
        <div class="examples">
          <div class="example-chip" onclick="useExample(this)">80s power ballad, big gated snare, 78 BPM</div>
          <div class="example-chip" onclick="useExample(this)">Chill trip hop groove with lots of swing</div>
          <div class="example-chip" onclick="useExample(this)">Simple blues shuffle for jamming</div>
          <div class="example-chip" onclick="useExample(this)">Classic 909 house beat, 124 BPM</div>
        </div>
      </div>
      <div class="typing-indicator" id="typing">
        <span>‚óè</span><span>‚óè</span><span>‚óè</span> Creating your groove...
      </div>
    </div>
  </div>

  <!-- Pattern Grid -->
  <div class="grid-panel" id="gridPanel">
    <div class="grid-table" id="gridTable"></div>
  </div>

  <!-- Controls -->
  <div class="controls" id="controlsPanel">
    <div class="controls-row">
      <button class="btn-play" id="btnPlay" onclick="togglePlay()">‚ñ∂</button>
      <div class="slider-group">
        <label>BPM</label>
        <input type="range" id="bpmSlider" min="30" max="300" value="120" oninput="updateBPM(this.value)">
        <span class="slider-val" id="bpmVal">120</span>
      </div>
      <div class="slider-group">
        <label>Swing</label>
        <input type="range" id="swingSlider" min="0" max="100" value="0" oninput="updateSwing(this.value)">
        <span class="slider-val" id="swingVal">0</span>
      </div>
    </div>
    <div class="controls-row">
      <div class="version-nav" id="versionNav">
        <button onclick="prevVersion()" id="btnPrevVer">‚óÄ</button>
        <span id="versionLabel">No pattern</span>
        <button onclick="nextVersion()" id="btnNextVer">‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="input-bar">
    <input type="text" id="msgInput" placeholder="Describe your beat..."
      onkeydown="if(event.key==='Enter')sendMessage()" autocomplete="off">
    <button class="btn-send" id="btnSend" onclick="sendMessage()">‚Üë</button>
  </div>

  <script>
    // --- State ---
    let ws = null;
    let currentSession = null;
    let sessions = [];
    let isPlaying = false;
    let currentStep = -1;
    let currentPattern = null;
    let sending = false;
    let reconnectTimer = null;

    // --- WebSocket ---
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        document.getElementById('statusDot').classList.remove('disconnected');
        document.getElementById('statusText').textContent = 'Connected';
        if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
      };

      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        handleWS(data);
      };

      ws.onclose = () => {
        document.getElementById('statusDot').classList.add('disconnected');
        document.getElementById('statusText').textContent = 'Reconnecting...';
        reconnectTimer = setTimeout(connect, 2000);
      };

      ws.onerror = () => ws.close();
    }

    function handleWS(data) {
      switch (data.type) {
        case 'state':
          isPlaying = data.playing;
          updatePlayButton();
          if (data.bpm) { document.getElementById('bpmSlider').value = data.bpm; document.getElementById('bpmVal').textContent = Math.round(data.bpm); }
          if (data.swing !== undefined) { document.getElementById('swingSlider').value = data.swing; document.getElementById('swingVal').textContent = Math.round(data.swing); }
          if (data.sessions) { sessions = data.sessions; renderSessionList(); }
          if (data.session) { loadSession(data.session); }
          if (data.pattern) { currentPattern = data.pattern; renderGrid(); }
          if (data.active_session) {
            document.getElementById('sessionSelect').value = data.active_session;
          }
          break;

        case 'step':
          currentStep = data.step;
          updateStepCursor();
          break;

        case 'pattern_update':
          document.getElementById('typing').classList.remove('show');
          sending = false;
          document.getElementById('btnSend').disabled = false;
          if (data.message) addMessage('assistant', data.message);
          if (data.pattern) {
            currentPattern = data.pattern;
            renderGrid();
            document.getElementById('gridPanel').classList.add('show');
            if (data.bpm) { document.getElementById('bpmSlider').value = data.bpm; document.getElementById('bpmVal').textContent = Math.round(data.bpm); }
            if (data.swing !== undefined) { document.getElementById('swingSlider').value = data.swing; document.getElementById('swingVal').textContent = Math.round(data.swing); }
          }
          if (data.playing !== undefined) { isPlaying = data.playing; updatePlayButton(); }
          if (data.version !== undefined) updateVersionNav(data.version, data.total_versions);
          break;

        case 'playback':
          isPlaying = data.playing;
          updatePlayButton();
          if (!data.playing) { currentStep = -1; updateStepCursor(); }
          break;

        case 'version_change':
          if (data.pattern) { currentPattern = data.pattern; renderGrid(); }
          if (data.bpm) { document.getElementById('bpmSlider').value = data.bpm; document.getElementById('bpmVal').textContent = Math.round(data.bpm); }
          if (data.swing !== undefined) { document.getElementById('swingSlider').value = data.swing; document.getElementById('swingVal').textContent = Math.round(data.swing); }
          if (data.version !== undefined) updateVersionNav(data.version, data.total_versions);
          break;

        case 'params':
          if (data.bpm) { document.getElementById('bpmSlider').value = data.bpm; document.getElementById('bpmVal').textContent = Math.round(data.bpm); }
          if (data.swing !== undefined) { document.getElementById('swingSlider').value = data.swing; document.getElementById('swingVal').textContent = Math.round(data.swing); }
          break;

        case 'generating':
          document.getElementById('typing').classList.add('show');
          scrollChat();
          break;

        case 'session_created':
          sessions.push(data.session);
          renderSessionList();
          break;

        case 'session_deleted':
          sessions = sessions.filter(s => s.id !== data.session_id);
          renderSessionList();
          if (currentSession && currentSession.id === data.session_id) {
            currentSession = null;
            currentPattern = null;
            document.getElementById('gridPanel').classList.remove('show');
            renderChat();
          }
          break;
      }
    }

    // --- Sessions ---
    function renderSessionList() {
      const sel = document.getElementById('sessionSelect');
      const val = sel.value;
      sel.innerHTML = '<option value="">Select session...</option>';
      sessions.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        sel.appendChild(opt);
      });
      sel.value = val;
    }

    async function createSession() {
      const name = prompt('Session name:', `Session ${sessions.length + 1}`);
      if (!name) return;
      const res = await fetch('/api/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const session = await res.json();
      currentSession = session;
      sessions.push(session);
      renderSessionList();
      document.getElementById('sessionSelect').value = session.id;
      currentPattern = null;
      document.getElementById('gridPanel').classList.remove('show');
      renderChat();
      document.getElementById('msgInput').focus();
    }

    async function switchSession(id) {
      if (!id) return;
      const res = await fetch(`/api/sessions/${id}`);
      const session = await res.json();
      loadSession(session);
    }

    function loadSession(session) {
      currentSession = session;
      document.getElementById('sessionSelect').value = session.id;
      if (session.patterns && session.patterns.length > 0 && session.current_version >= 0) {
        currentPattern = session.patterns[session.current_version];
        renderGrid();
        document.getElementById('gridPanel').classList.add('show');
        updateVersionNav(session.current_version, session.patterns.length);
        const p = currentPattern;
        if (p.bpm) { document.getElementById('bpmSlider').value = p.bpm; document.getElementById('bpmVal').textContent = Math.round(p.bpm); }
        if (p.swing !== undefined) { document.getElementById('swingSlider').value = p.swing; document.getElementById('swingVal').textContent = Math.round(p.swing); }
      } else {
        currentPattern = null;
        document.getElementById('gridPanel').classList.remove('show');
      }
      renderChat();
    }

    // --- Chat ---
    function renderChat() {
      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      if (!currentSession) {
        chat.innerHTML = document.getElementById('welcome') ? '' : '';
        // Re-add welcome
        chat.innerHTML = `
      <div class="welcome">
        <h2>ü•Å Ready to jam</h2>
        <p>Create a session and describe the beat you want. I'll program your TR-8S in real time.</p>
        <div class="examples">
          <div class="example-chip" onclick="useExample(this)">80s power ballad, big gated snare, 78 BPM</div>
          <div class="example-chip" onclick="useExample(this)">Chill trip hop groove with lots of swing</div>
          <div class="example-chip" onclick="useExample(this)">Simple blues shuffle for jamming</div>
          <div class="example-chip" onclick="useExample(this)">Classic 909 house beat, 124 BPM</div>
        </div>
      </div>`;
        return;
      }
      currentSession.conversation.forEach(msg => {
        addMessage(msg.role, msg.content, false);
      });
      // Re-add typing indicator
      const ti = document.createElement('div');
      ti.className = 'typing-indicator';
      ti.id = 'typing';
      ti.innerHTML = '<span>‚óè</span><span>‚óè</span><span>‚óè</span> Creating your groove...';
      chat.appendChild(ti);
      scrollChat();
    }

    function addMessage(role, content, scroll = true) {
      const chat = document.getElementById('chat');
      const welcome = chat.querySelector('.welcome');
      if (welcome) welcome.remove();

      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = content;
      // Insert before typing indicator
      const typing = document.getElementById('typing');
      if (typing) {
        chat.insertBefore(div, typing);
      } else {
        chat.appendChild(div);
      }
      if (scroll) scrollChat();
    }

    function scrollChat() {
      const chat = document.getElementById('chat');
      requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
    }

    // --- Send Message ---
    async function sendMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || sending) return;

      // Auto-create session if none selected
      if (!currentSession) {
        const res = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: text.slice(0, 40) })
        });
        const session = await res.json();
        currentSession = session;
        renderSessionList();
        document.getElementById('sessionSelect').value = session.id;
        renderChat();
      }

      sending = true;
      input.value = '';
      document.getElementById('btnSend').disabled = true;
      addMessage('user', text);
      document.getElementById('typing').classList.add('show');
      scrollChat();

      try {
        const res = await fetch(`/api/sessions/${currentSession.id}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: text })
        });
        const data = await res.json();

        if (data.error) {
          document.getElementById('typing').classList.remove('show');
          addMessage('system', `Error: ${data.error}`);
          sending = false;
          document.getElementById('btnSend').disabled = false;
          return;
        }

        // Update local session state
        currentSession.conversation.push({ role: 'user', content: text });
        currentSession.conversation.push({ role: 'assistant', content: data.message });
        if (data.pattern) {
          currentSession.patterns = currentSession.patterns || [];
          currentSession.patterns.push(data.pattern);
          currentSession.current_version = data.version;
        }

        // WS will handle the UI update via pattern_update event
        // But if WS is slow, handle it here as fallback
        setTimeout(() => {
          if (sending) {
            document.getElementById('typing').classList.remove('show');
            sending = false;
            document.getElementById('btnSend').disabled = false;
          }
        }, 15000);

      } catch (err) {
        document.getElementById('typing').classList.remove('show');
        addMessage('system', `Error: ${err.message}`);
        sending = false;
        document.getElementById('btnSend').disabled = false;
      }
    }

    function useExample(el) {
      document.getElementById('msgInput').value = el.textContent;
      document.getElementById('msgInput').focus();
    }

    // --- Pattern Grid ---
    const INST_ORDER = ['BD', 'SD', 'CH', 'OH', 'CP', 'RS', 'RC', 'CC', 'LT', 'MT', 'HT'];

    function renderGrid() {
      const table = document.getElementById('gridTable');
      if (!currentPattern || !currentPattern.instruments) {
        table.innerHTML = '';
        return;
      }

      const insts = currentPattern.instruments;
      // Only show instruments that are in the pattern
      const activeInsts = INST_ORDER.filter(i => insts[i]);

      table.innerHTML = '';
      activeInsts.forEach(inst => {
        const row = document.createElement('div');
        row.className = 'grid-row';

        const label = document.createElement('div');
        label.className = 'grid-label';
        label.textContent = inst;
        row.appendChild(label);

        const steps = document.createElement('div');
        steps.className = 'grid-steps';
        const stepData = insts[inst].steps || [];

        for (let i = 0; i < 16; i++) {
          const step = document.createElement('div');
          step.className = 'grid-step';
          step.dataset.inst = inst;
          step.dataset.step = i;
          const vel = stepData[i] || 0;
          if (vel > 80) step.classList.add('on');
          else if (vel > 0) step.classList.add('ghost');
          if (i % 4 === 0) step.classList.add('beat-marker');
          if (i === currentStep) step.classList.add('cursor');
          steps.appendChild(step);
        }
        row.appendChild(steps);
        table.appendChild(row);
      });
    }

    function updateStepCursor() {
      document.querySelectorAll('.grid-step.cursor').forEach(el => el.classList.remove('cursor'));
      if (currentStep >= 0) {
        document.querySelectorAll(`.grid-step[data-step="${currentStep}"]`).forEach(el => el.classList.add('cursor'));
      }
    }

    // --- Controls ---
    function togglePlay() {
      fetch(isPlaying ? '/api/stop' : '/api/play', { method: 'POST' });
    }

    function updatePlayButton() {
      const btn = document.getElementById('btnPlay');
      btn.textContent = isPlaying ? '‚èπ' : '‚ñ∂';
      btn.classList.toggle('playing', isPlaying);
    }

    let bpmTimeout = null;
    function updateBPM(val) {
      document.getElementById('bpmVal').textContent = Math.round(val);
      clearTimeout(bpmTimeout);
      bpmTimeout = setTimeout(() => {
        fetch('/api/params', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bpm: parseFloat(val) })
        });
      }, 100);
    }

    let swingTimeout = null;
    function updateSwing(val) {
      document.getElementById('swingVal').textContent = Math.round(val);
      clearTimeout(swingTimeout);
      swingTimeout = setTimeout(() => {
        fetch('/api/params', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ swing: parseFloat(val) })
        });
      }, 100);
    }

    function updateVersionNav(version, total) {
      document.getElementById('versionLabel').textContent = `v${version + 1} of ${total}`;
      document.getElementById('btnPrevVer').disabled = version <= 0;
      document.getElementById('btnNextVer').disabled = version >= total - 1;
      // Store for nav
      document.getElementById('versionNav').dataset.version = version;
      document.getElementById('versionNav').dataset.total = total;
    }

    function prevVersion() {
      const nav = document.getElementById('versionNav');
      const v = parseInt(nav.dataset.version || 0);
      if (v > 0 && currentSession) {
        fetch(`/api/sessions/${currentSession.id}/version/${v - 1}`, { method: 'POST' });
      }
    }

    function nextVersion() {
      const nav = document.getElementById('versionNav');
      const v = parseInt(nav.dataset.version || 0);
      const total = parseInt(nav.dataset.total || 0);
      if (v < total - 1 && currentSession) {
        fetch(`/api/sessions/${currentSession.id}/version/${v + 1}`, { method: 'POST' });
      }
    }

    // --- Init ---
    connect();
    document.getElementById('msgInput').focus();
  </script>
</body>

</html>